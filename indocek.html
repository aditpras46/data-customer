<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Master - GitHub DB Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #000000;
        }
        .fade-in {
            animation: fadeIn 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom scrollbar ultra minimalis */
        .suggestion-box::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar,
        textarea::-webkit-scrollbar {
            width: 3px;
        }
        .suggestion-box::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track,
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .suggestion-box::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb,
        textarea::-webkit-scrollbar-thumb {
            background: #000000;
        }
        input::placeholder, textarea::placeholder {
            color: #d1d5db;
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Loading Spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col min-h-screen">

    <!-- Container Utama: Posisi di atas (Top Aligned) -->
    <div class="w-full max-w-md mx-auto flex flex-col mt-4 md:mt-8">
        <!-- Header Kecil -->
        <header class="mb-8 border-b border-black pb-2 flex justify-between items-end">
            <div>
                <div class="flex items-center gap-2">
                    <h1 id="pageTitle" class="text-lg font-black tracking-tighter uppercase">Penjualan</h1>
                    <!-- TOMBOL NOTE (Toggle Switch) -->
                    <button id="noteToggleBtn" type="button" class="text-[9px] font-bold uppercase border border-black px-2 py-0.5 hover:bg-gray-200 transition-colors" title="Tandai sebagai Note">
                        + Note
                    </button>
                </div>
                <p id="connectionStatus" class="text-[9px] text-gray-400 uppercase tracking-widest">System Ready</p>
            </div>
            <div class="flex gap-2 mb-1">
                <!-- Tombol Pengaturan -->
                <button id="settingsBtn" class="text-[9px] font-bold uppercase border border-black px-2 py-0.5 hover:bg-black hover:text-white transition-colors flex items-center justify-center" title="Pengaturan">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <button id="openListBtn" class="text-[9px] font-bold uppercase border border-black px-2 py-0.5 hover:bg-black hover:text-white transition-colors flex items-center gap-2">
                    Data (<span id="countBadge">-</span>)
                </button>
            </div>
        </header>

        <!-- Form Section - Centered & Focused -->
        <div>
            <form id="dataForm" class="space-y-4" autocomplete="off">
                <div class="relative">
                    <label class="block text-[9px] font-black uppercase mb-0.5 text-gray-400">Pembeli</label>
                    <input type="text" id="userName" required 
                        class="w-full px-0 py-1 text-lg font-bold border-b-2 border-gray-100 focus:border-black outline-none transition-colors bg-transparent placeholder-gray-200"
                        placeholder="Nama...">
                    <div id="userSuggestionBox" class="suggestion-box hidden absolute z-40 w-full mt-0.5 bg-white border border-black max-h-[160px] overflow-y-auto text-sm shadow-xl"></div>
                </div>
                
                <!-- INPUT PENJUALAN -->
                <div id="salesInputs">
                    <!-- Group Barang & Variant -->
                    <div class="flex gap-4">
                        <div class="relative flex-grow w-[70%]">
                            <label class="block text-[9px] font-black uppercase mb-0.5 text-gray-400">Barang</label>
                            <input type="text" id="itemName" required
                                class="w-full px-0 py-1 text-lg font-bold border-b-2 border-gray-100 focus:border-black outline-none transition-colors bg-transparent placeholder-gray-200"
                                placeholder="Produk...">
                            <div id="itemSuggestionBox" class="suggestion-box hidden absolute z-40 w-full mt-0.5 bg-white border border-black max-h-[160px] overflow-y-auto text-sm shadow-xl"></div>
                        </div>

                        <div class="relative w-[30%]">
                            <label class="block text-[9px] font-black uppercase mb-0.5 text-gray-400">Warna/Size</label>
                            <input type="text" id="itemVariant" 
                                class="w-full px-0 py-1 text-lg font-bold border-b-2 border-gray-100 focus:border-black outline-none transition-colors bg-transparent placeholder-gray-200"
                                placeholder="XL">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6 mt-4">
                        <div>
                            <label class="block text-[9px] font-black uppercase mb-0.5 text-gray-400">Qty</label>
                            <input type="number" id="itemQty" min="0"
                                class="w-full px-0 py-1 text-lg font-bold border-b-2 border-gray-100 focus:border-black outline-none bg-transparent placeholder-gray-200"
                                placeholder="1">
                        </div>
                        <div>
                            <label class="block text-[9px] font-black uppercase mb-0.5 text-gray-400">Harga</label>
                            <input type="number" id="itemPrice" required min="0"
                                class="w-full px-0 py-1 text-lg font-bold border-b-2 border-gray-100 focus:border-black outline-none bg-transparent placeholder-gray-200"
                                placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- Tombol Submit & Cancel -->
                <div class="flex gap-2 mt-6">
                    <button type="button" id="cancelEditBtn" onclick="cancelEdit()" class="hidden w-1/3 bg-gray-100 text-gray-500 text-[10px] font-bold uppercase py-3 hover:bg-gray-200 hover:text-black transition-colors tracking-widest">
                        Batal
                    </button>
                    <button type="submit" id="submitBtn"
                        class="flex-grow bg-black text-white text-[10px] font-bold uppercase py-3 hover:bg-gray-800 transition-all active:scale-95 tracking-[0.2em] shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        Simpan Data
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Popup List -->
    <div id="dataModal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-white/95 backdrop-blur-sm" id="modalBackdrop"></div>
        
        <!-- Modal Content -->
        <div class="absolute inset-0 flex flex-col p-4 md:p-8 max-w-4xl mx-auto h-full fade-in">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-black">
                <div>
                    <h2 class="text-lg font-black uppercase tracking-tighter">Database</h2>
                    <p class="text-[9px] text-gray-400 uppercase tracking-widest flex items-center gap-2">
                        <span id="sourceIndicator">Local/Cloud</span>
                        <span id="refreshIndicator" class="hidden w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                    </p>
                </div>
                <div class="flex gap-4 items-center">
                    <button id="refreshBtn" class="text-[9px] font-bold uppercase hover:text-blue-600 flex items-center gap-1">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                        Refresh
                    </button>
                    <button id="downloadCSV" class="text-[9px] font-bold uppercase hover:text-gray-500">CSV</button>
                    <button id="closeModalBtn" class="ml-4 w-6 h-6 flex items-center justify-center bg-black text-white rounded-full hover:bg-gray-800">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>

            <!-- Scrollable Table Area -->
            <div class="flex-grow overflow-auto modal-content pr-2 relative">
                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center hidden">
                    <div class="loader mb-2"></div>
                    <p class="text-[9px] font-bold uppercase tracking-widest">Mengambil Data...</p>
                </div>

                <table class="w-full text-left border-collapse table-fixed">
                    <thead class="sticky top-0 bg-white z-10">
                        <tr class="border-b border-black text-[9px] uppercase font-black tracking-widest">
                            <th class="py-2 pr-2 w-[25%] bg-white">Pembeli</th>
                            <th class="py-2 pr-2 w-[35%] bg-white">Barang / Ket</th>
                            <th class="py-2 pr-2 text-center w-[10%] bg-white">Qty</th>
                            <th class="py-2 pr-2 text-right w-[15%] bg-white">Harga</th>
                            <th class="py-2 pr-2 text-right w-[15%] bg-white">Total</th>
                            <th class="py-2 text-right w-[10%] bg-white">Action</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="text-[10px] font-medium"></tbody>
                </table>
                
                <div id="emptyState" class="py-20 text-center hidden">
                    <p class="text-[9px] text-gray-300 uppercase tracking-widest font-bold">Data Kosong</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Settings -->
    <div id="settingsModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-white/95 backdrop-blur-sm" id="settingsBackdrop"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-6 bg-white border border-black shadow-2xl fade-in overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6 border-b border-black pb-2">
                <h2 class="text-lg font-black uppercase tracking-tighter">Konfigurasi</h2>
                <button id="closeSettingsBtn" class="w-6 h-6 flex items-center justify-center bg-black text-white rounded-full hover:bg-gray-800">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- GITHUB SECTION -->
                <div class="bg-gray-50 p-3 rounded border border-gray-100">
                    <h3 class="text-[10px] font-bold uppercase mb-2 text-gray-500">Integrasi GitHub (Database)</h3>
                    <div class="space-y-2">
                         <div>
                            <label class="block text-[9px] font-black uppercase mb-1 text-gray-400">Access Token (Required)</label>
                            <input type="password" id="configGithubToken" 
                                class="w-full px-2 py-1.5 text-xs font-mono border border-gray-200 focus:border-black outline-none transition-colors"
                                placeholder="ghp_...">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <label class="block text-[9px] font-black uppercase mb-1 text-gray-400">Username</label>
                                <input type="text" id="configGithubUser" 
                                    class="w-full px-2 py-1.5 text-xs font-mono border border-gray-200 focus:border-black outline-none transition-colors"
                                    placeholder="user">
                            </div>
                             <div>
                                <label class="block text-[9px] font-black uppercase mb-1 text-gray-400">Repo Name</label>
                                <input type="text" id="configGithubRepo" 
                                    class="w-full px-2 py-1.5 text-xs font-mono border border-gray-200 focus:border-black outline-none transition-colors"
                                    placeholder="my-repo">
                            </div>
                        </div>
                        <div>
                            <label class="block text-[9px] font-black uppercase mb-1 text-gray-400">File Path (JSON)</label>
                            <input type="text" id="configGithubPath" 
                                class="w-full px-2 py-1.5 text-xs font-mono border border-gray-200 focus:border-black outline-none transition-colors"
                                placeholder="data-customer.json">
                        </div>
                    </div>
                </div>

                <!-- LEGACY SECTION -->
                <div class="pt-2 border-t border-gray-100">
                    <h3 class="text-[10px] font-bold uppercase mb-2 text-gray-500">Legacy / Backup</h3>
                    <div class="mb-2">
                        <label class="block text-[9px] font-black uppercase mb-1 text-gray-400">Google Script URL</label>
                        <input type="text" id="configScriptUrl" 
                            class="w-full px-2 py-1.5 text-xs font-mono border border-gray-200 focus:border-black outline-none transition-colors"
                            placeholder="https://script.google.com/...">
                    </div>
                    
                    <div>
                        <label class="block text-[9px] font-black uppercase mb-1 text-gray-400">CSV URL</label>
                        <input type="text" id="configCsvUrl" 
                            class="w-full px-2 py-1.5 text-xs font-mono border border-gray-200 focus:border-black outline-none transition-colors"
                            placeholder="https://docs.google.com/...">
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button id="saveSettingsBtn" class="flex-grow bg-black text-white text-[10px] font-bold uppercase py-2 hover:bg-gray-800 transition-transform active:scale-95 tracking-widest">
                        Simpan & Reload
                    </button>
                    <button id="resetSettingsBtn" class="px-3 border border-red-200 text-red-500 text-[10px] font-bold uppercase py-2 hover:bg-red-50 hover:border-red-500 hover:text-red-600 transition-colors" title="Reset ke Default">
                        Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Minimalis -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-black text-white px-5 py-2 text-[9px] font-bold uppercase tracking-widest opacity-0 pointer-events-none transition-opacity duration-300 shadow-xl z-[70] w-max max-w-[90%] text-center">
        <span id="toastMsg">Saved</span>
    </div>

    <script>
        // ==========================================
        // INITIAL JSON DATABASE (Sample Data)
        const INITIAL_DATABASE = [
            { "timestamp": "19/01/2026, 08:30:00", "nama": "Sample Github", "barang": "Test Item", "qty": 1, "harga": 1000, "total": 1000, "keterangan": "System Init", "id": 1705627800001 }
        ];
        // ==========================================

        // KONFIGURASI DEFAULT
        const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwoAG128uLYLuWRK-Lr0dOSHGY18AIwU4wtQEw8Tt3AHnlNwGBpHHogEIHeUgrZGTCSQg/exec'; 
        const DEFAULT_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSrkuptW1fDV77qah95TTP_DvmoULn6Mq59ZbK_T_K_WLmPAlYKmwP0RbZ3l122r9xdDjr_Rr71X3tb/pub?output=csv';
        
        // LOAD CONFIG
        let GOOGLE_SCRIPT_URL = localStorage.getItem('inventoryScriptUrl') || DEFAULT_SCRIPT_URL;
        let GOOGLE_SHEET_CSV_URL = localStorage.getItem('inventoryCsvUrl') || DEFAULT_CSV_URL;
        
        // GITHUB CONFIG
        let GH_TOKEN = localStorage.getItem('inventoryGithubToken') || '';
        let GH_USER = localStorage.getItem('inventoryGithubUser') || '';
        let GH_REPO = localStorage.getItem('inventoryGithubRepo') || '';
        // UPDATE DEFAULT PATH
        let GH_PATH = localStorage.getItem('inventoryGithubPath') || 'data-customer.json';
        
        // ==========================================

        // Local Storage Data
        let savedNames = JSON.parse(localStorage.getItem('inventorySavedNames')) || [];
        let savedProducts = JSON.parse(localStorage.getItem('inventorySavedProducts')) || {};
        
        let cloudData = [];
        let refreshInterval; 
        let isNoteActive = false;
        let editMode = false;
        let editId = null;

        // Elements
        const dataForm = document.getElementById('dataForm');
        const dataTableBody = document.getElementById('dataTableBody');
        const emptyState = document.getElementById('emptyState');
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMsg');
        const downloadBtn = document.getElementById('downloadCSV');
        const countBadge = document.getElementById('countBadge');
        const connectionStatus = document.getElementById('connectionStatus');
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshIndicator = document.getElementById('refreshIndicator');
        const noteToggleBtn = document.getElementById('noteToggleBtn');
        const sourceIndicator = document.getElementById('sourceIndicator');

        // Buttons
        const submitBtn = document.getElementById('submitBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        // Modal Elements
        const dataModal = document.getElementById('dataModal');
        const openListBtn = document.getElementById('openListBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Settings Elements
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const settingsBackdrop = document.getElementById('settingsBackdrop');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const resetSettingsBtn = document.getElementById('resetSettingsBtn');
        
        const configScriptUrl = document.getElementById('configScriptUrl');
        const configCsvUrl = document.getElementById('configCsvUrl');
        const configGithubToken = document.getElementById('configGithubToken');
        const configGithubUser = document.getElementById('configGithubUser');
        const configGithubRepo = document.getElementById('configGithubRepo');
        const configGithubPath = document.getElementById('configGithubPath');
        
        // Inputs
        const nameInput = document.getElementById('userName');
        const userSuggestionBox = document.getElementById('userSuggestionBox');
        const itemInput = document.getElementById('itemName');
        const itemVariantInput = document.getElementById('itemVariant');
        const itemQtyInput = document.getElementById('itemQty');
        const itemPriceInput = document.getElementById('itemPrice');
        const itemSuggestionBox = document.getElementById('itemSuggestionBox');

        // Initialize
        checkConnection();
        loadDataFromCloud(true);

        function checkConnection() {
            if (GH_TOKEN && GH_USER && GH_REPO) {
                connectionStatus.innerText = "GitHub DB Ready";
                connectionStatus.className = "text-[9px] uppercase tracking-widest text-blue-600 font-bold";
            } else if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('https://script.google.com')) {
                connectionStatus.innerText = "G-Cloud Ready";
                connectionStatus.className = "text-[9px] uppercase tracking-widest text-green-600 font-bold";
            } else {
                connectionStatus.innerText = "Local Database";
                connectionStatus.className = "text-[9px] uppercase tracking-widest text-gray-500 font-bold";
            }
        }

        // --- GITHUB API HELPER ---
        async function fetchFromGitHub() {
            if (!GH_TOKEN || !GH_USER || !GH_REPO || !GH_PATH) return null;
            
            const url = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_PATH}`;
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${GH_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (response.status === 404) return []; // File doesn't exist yet
            if (!response.ok) throw new Error("GitHub Error: " + response.status);

            const data = await response.json();
            // Decode Base64 content (handles special chars)
            const content = decodeURIComponent(escape(atob(data.content)));
            return JSON.parse(content);
        }

        async function saveToGitHub(data) {
            if (!GH_TOKEN || !GH_USER || !GH_REPO || !GH_PATH) return false;

            const url = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_PATH}`;
            
            // 1. Get current SHA (if file exists)
            let sha = null;
            try {
                const getRes = await fetch(url, {
                    headers: { 'Authorization': `token ${GH_TOKEN}` }
                });
                if (getRes.ok) {
                    const getData = await getRes.json();
                    sha = getData.sha;
                }
            } catch (e) { console.log('File likely does not exist yet'); }

            // 2. Prepare PUT request
            const contentEncoded = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
            
            const body = {
                message: "Update database via Input Master",
                content: contentEncoded
            };
            if (sha) body.sha = sha;

            const putRes = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GH_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!putRes.ok) throw new Error("Failed to save to GitHub");
            return true;
        }

        // --- LOCAL DB HELPER ---
        function getLocalDB() {
            const stored = localStorage.getItem('local_inventory_db');
            if (!stored) {
                localStorage.setItem('local_inventory_db', JSON.stringify(INITIAL_DATABASE));
                return INITIAL_DATABASE;
            }
            return JSON.parse(stored);
        }
        function saveToLocalDB(data) { localStorage.setItem('local_inventory_db', JSON.stringify(data)); }

        // --- SETTINGS LOGIC ---
        function openSettings() {
            configScriptUrl.value = GOOGLE_SCRIPT_URL;
            configCsvUrl.value = GOOGLE_SHEET_CSV_URL;
            configGithubToken.value = GH_TOKEN;
            configGithubUser.value = GH_USER;
            configGithubRepo.value = GH_REPO;
            configGithubPath.value = GH_PATH;
            settingsModal.classList.remove('hidden');
        }

        function closeSettings() { settingsModal.classList.add('hidden'); }

        function saveSettings() {
            GH_TOKEN = configGithubToken.value.trim();
            GH_USER = configGithubUser.value.trim();
            GH_REPO = configGithubRepo.value.trim();
            GH_PATH = configGithubPath.value.trim();
            GOOGLE_SCRIPT_URL = configScriptUrl.value.trim();
            GOOGLE_SHEET_CSV_URL = configCsvUrl.value.trim();

            localStorage.setItem('inventoryGithubToken', GH_TOKEN);
            localStorage.setItem('inventoryGithubUser', GH_USER);
            localStorage.setItem('inventoryGithubRepo', GH_REPO);
            localStorage.setItem('inventoryGithubPath', GH_PATH);
            localStorage.setItem('inventoryScriptUrl', GOOGLE_SCRIPT_URL);
            localStorage.setItem('inventoryCsvUrl', GOOGLE_SHEET_CSV_URL);

            checkConnection();
            showToast("Konfigurasi Disimpan");
            closeSettings();
            loadDataFromCloud();
        }

        function resetSettings() {
            if(confirm("Reset konfigurasi?")) {
                configScriptUrl.value = DEFAULT_SCRIPT_URL;
                configCsvUrl.value = DEFAULT_CSV_URL;
                configGithubToken.value = ''; 
                configGithubUser.value = '';
                configGithubRepo.value = '';
                configGithubPath.value = 'data-customer.json';
            }
        }

        // --- MAIN DATA FLOW ---
        async function loadDataFromCloud(isAutoRefresh = false) {
            if (isAutoRefresh) refreshIndicator.classList.remove('hidden');
            if (!isAutoRefresh) {
                loadingOverlay.classList.remove('hidden');
                dataTableBody.innerHTML = ''; 
            }

            try {
                // 1. Try GitHub First
                if (GH_TOKEN && GH_USER && GH_REPO && GH_PATH) {
                    try {
                        const ghData = await fetchFromGitHub();
                        if (ghData) {
                            cloudData = ghData;
                            sourceIndicator.innerText = "GitHub DB";
                            sourceIndicator.className = "font-bold text-blue-600";
                            renderCloudTable(cloudData);
                            return; // Stop here if GitHub works
                        }
                    } catch (e) { console.warn("GitHub fetch error:", e); }
                }

                // 2. Try Google Script
                if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) {
                    const antiCacheURL = GOOGLE_SCRIPT_URL + (GOOGLE_SCRIPT_URL.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                    const res = await fetch(antiCacheURL);
                    const data = await res.json();
                    cloudData = data;
                    sourceIndicator.innerText = "Google Cloud";
                    sourceIndicator.className = "font-bold text-green-600";
                    renderCloudTable(cloudData);
                    return; // Stop here if G-Script works
                }

                // 3. Fallback to Local
                throw new Error("No cloud source active");

            } catch (error) {
                // FALLBACK LOCAL
                cloudData = getLocalDB();
                sourceIndicator.innerText = "Local Storage";
                sourceIndicator.className = "font-bold text-gray-500";
                renderCloudTable(cloudData);
            } finally {
                loadingOverlay.classList.add('hidden');
                refreshIndicator.classList.add('hidden');
            }
        }

        // --- TABLE RENDER ---
        function renderCloudTable(data) {
            dataTableBody.innerHTML = '';
            if (!Array.isArray(data) || data.length === 0) {
                emptyState.classList.remove('hidden');
                countBadge.innerText = "0";
                return;
            }
            emptyState.classList.add('hidden');
            
            const reversedData = [...data].reverse();
            let validRows = 0;

            reversedData.forEach(item => {
                const nama = getFlexValue(item, ['nama', 'name', 'pembeli']) || '';
                const barang = getFlexValue(item, ['barang', 'item', 'produk']) || '';
                const keterangan = getFlexValue(item, ['keterangan', 'note', 'catatan']) || ''; 
                if (!nama && !barang && !keterangan) return;

                validRows++;
                const qty = getFlexValue(item, ['qty', 'jumlah']) || 0;
                const harga = getFlexValue(item, ['harga', 'price']) || 0;
                const total = getFlexValue(item, ['total']) || 0;
                const id = getFlexValue(item, ['id', 'uuid', 'uid']) || ''; 

                let displayBarang = barang;
                if (keterangan) {
                    displayBarang += `<div class="text-[9px] text-gray-400 italic mt-0.5 border-l border-gray-300 pl-1">${keterangan}</div>`;
                }

                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-gray-50 group transition-colors';
                row.innerHTML = `
                    <td class="py-1.5 pr-2 font-bold uppercase truncate" title="${nama}">${nama}</td>
                    <td class="py-1.5 pr-2 truncate text-gray-600" title="${barang}">${displayBarang}</td>
                    <td class="py-1.5 pr-2 text-center text-gray-500">${qty || '-'}</td>
                    <td class="py-1.5 pr-2 text-right text-gray-500">${formatNumber(harga) || '-'}</td>
                    <td class="py-1.5 pr-2 text-right font-black">${formatNumber(total) || '-'}</td>
                    <td class="py-1.5 text-right flex justify-end items-center gap-1">
                        <button onclick="editItem('${id}')" class="text-gray-300 hover:text-blue-600 transition-colors p-1"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                        <button onclick="deleteItem('${id}')" class="text-gray-300 hover:text-red-600 transition-colors p-1"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </td>
                `;
                dataTableBody.appendChild(row);
            });
            countBadge.innerText = validRows;
            if (validRows === 0) emptyState.classList.remove('hidden');
        }

        // --- SUBMIT LOGIC ---
        dataForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ... (Data gathering logic remains same) ...
            const userName = nameInput.value.trim();
            const productName = itemInput.value.trim();
            const variant = itemVariantInput.value.trim();
            const note = isNoteActive ? "Note" : "";
            let qty = parseInt(itemQtyInput.value);
            if (isNaN(qty) || qty <= 0) qty = 1;
            const price = parseFloat(itemPriceInput.value) || 0;
            const total = qty * price;
            const timestamp = new Date().toLocaleString('id-ID');
            const currentId = editMode ? editId : Date.now();
            const combinedProduct = variant ? `${productName} ${variant}` : productName;

            // Save Suggestions
            if (userName && !savedNames.includes(userName)) {
                savedNames.push(userName);
                localStorage.setItem('inventorySavedNames', JSON.stringify(savedNames));
            }
            if (productName) {
                savedProducts[productName] = price;
                localStorage.setItem('inventorySavedProducts', JSON.stringify(savedProducts));
            }

            const tempItem = {
                timestamp: timestamp,
                nama: userName,
                barang: combinedProduct,
                qty: qty,
                harga: price,
                total: total,
                keterangan: note,
                id: currentId
            };

            // 1. Update UI Array
            if (editMode) {
                const index = cloudData.findIndex(x => x.id == currentId || x.uid == currentId);
                if (index !== -1) cloudData[index] = tempItem;
            } else {
                cloudData.push(tempItem);
            }

            // 2. Local Backup
            saveToLocalDB(cloudData);

            // 3. Cloud Sync (GitHub First, then Legacy)
            let synced = false;
            
            if (GH_TOKEN && GH_USER && GH_REPO && GH_PATH) {
                try {
                    await saveToGitHub(cloudData);
                    showToast("Synced to GitHub");
                    synced = true;
                } catch (e) {
                    console.error("GitHub Sync Failed", e);
                    showToast("GitHub Fail (Saved Local)");
                }
            }
            
            if (!synced && GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) {
                // Legacy Sync... (Code condensed for brevity)
                const formData = new FormData();
                formData.append('id', currentId);
                formData.append('nama', userName);
                formData.append('barang', combinedProduct);
                formData.append('qty', qty);
                formData.append('harga', price);
                formData.append('total', total);
                formData.append('timestamp', timestamp);
                formData.append('keterangan', note);
                if(editMode) formData.append('action', 'edit');
                
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData, mode: 'no-cors' })
                    .then(() => showToast("Synced to G-Script"))
                    .catch(() => {});
            }

            if(!synced && !GOOGLE_SCRIPT_URL) showToast("Saved Locally");

            renderCloudTable(cloudData);
            cancelEdit();
        });

        // --- DELETE LOGIC ---
        window.deleteItem = async function(id) {
            if (!id) return;
            if(confirm('Hapus item ini?')) {
                cloudData = cloudData.filter(item => item.id != id && item.uid != id);
                renderCloudTable(cloudData);
                saveToLocalDB(cloudData);

                if(GH_TOKEN && GH_USER && GH_REPO) {
                    try {
                        await saveToGitHub(cloudData);
                        showToast("Deleted from GitHub");
                    } catch(e) { showToast("Delete Local Only"); }
                } else if (GOOGLE_SCRIPT_URL) {
                    const formData = new FormData();
                    formData.append('action', 'delete');
                    formData.append('id', id);
                    fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData, mode: 'no-cors' });
                    showToast("Delete Sent to G-Script");
                }
            }
        }

        // --- HELPER FUNCTIONS & EVENT LISTENERS ---
        // (Existing Logic for Suggestions, Toggle Note, Edit Mode, CSV Export, etc.)
        function formatNumber(number) { return new Intl.NumberFormat('id-ID').format(number); }
        function showToast(message) {
            toastMsg.innerText = message;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }
        function getFlexValue(item, possibleKeys) {
            const itemKeys = Object.keys(item).map(k => k.toLowerCase());
            for (let key of possibleKeys) {
                if (item[key]) return item[key];
                const foundKey = itemKeys.find(k => k.includes(key));
                if (foundKey) return item[foundKey];
            }
            return null;
        }

        // Standard Listeners
        noteToggleBtn.addEventListener('click', () => { isNoteActive = !isNoteActive; updateNoteButtonState(); });
        function updateNoteButtonState() {
            if (isNoteActive) { noteToggleBtn.classList.add('bg-black', 'text-white'); noteToggleBtn.classList.remove('hover:bg-gray-200'); }
            else { noteToggleBtn.classList.remove('bg-black', 'text-white'); noteToggleBtn.classList.add('hover:bg-gray-200'); }
        }
        
        settingsBtn.addEventListener('click', openSettings);
        closeSettingsBtn.addEventListener('click', closeSettings);
        settingsBackdrop.addEventListener('click', closeSettings);
        saveSettingsBtn.addEventListener('click', saveSettings);
        resetSettingsBtn.addEventListener('click', resetSettings);
        
        openListBtn.addEventListener('click', openModal);
        refreshBtn.addEventListener('click', () => loadDataFromCloud(false)); 
        closeModalBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', closeModal);

        function openModal() {
            dataModal.classList.remove('hidden');
            loadDataFromCloud();
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => { loadDataFromCloud(true); }, 3000); 
        }
        function closeModal() {
            dataModal.classList.add('hidden');
            if (refreshInterval) clearInterval(refreshInterval);
        }

        window.editItem = function(id) {
            const item = cloudData.find(x => x.id == id || x.uid == id || x.uuid == id);
            if (!item) return;
            nameInput.value = item.nama || '';
            itemInput.value = item.barang || '';
            itemQtyInput.value = item.qty || 1;
            itemPriceInput.value = item.harga || 0;
            editMode = true;
            editId = id;
            submitBtn.innerText = "Update Data";
            submitBtn.classList.replace('bg-black', 'bg-blue-600');
            cancelEditBtn.classList.remove('hidden');
            closeModal();
            nameInput.focus();
        }

        window.cancelEdit = function() {
            editMode = false;
            editId = null;
            dataForm.reset();
            submitBtn.innerText = "Simpan Data";
            submitBtn.classList.replace('bg-blue-600', 'bg-black');
            cancelEditBtn.classList.add('hidden');
        }

        // Suggestions Logic (Condensed)
        nameInput.addEventListener('input', (e) => handleSuggestion(e.target.value, savedNames, userSuggestionBox, (val) => nameInput.value = val));
        itemInput.addEventListener('input', (e) => handleSuggestion(e.target.value, Object.keys(savedProducts), itemSuggestionBox, (val) => {
            itemInput.value = val;
            if(savedProducts[val]) itemPriceInput.value = savedProducts[val];
        }));

        function handleSuggestion(val, source, box, onSelect) {
            if(!val) return box.classList.add('hidden');
            const filtered = source.filter(x => x.toLowerCase().includes(val.toLowerCase())).slice(0,5);
            if(filtered.length){
                box.innerHTML = '';
                filtered.forEach(txt => {
                    const d = document.createElement('div');
                    d.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-50';
                    d.innerText = txt;
                    d.onclick = () => { onSelect(txt); box.classList.add('hidden'); };
                    box.appendChild(d);
                });
                box.classList.remove('hidden');
            } else box.classList.add('hidden');
        }
        document.addEventListener('click', (e) => {
            if(!nameInput.contains(e.target)) userSuggestionBox.classList.add('hidden');
            if(!itemInput.contains(e.target)) itemSuggestionBox.classList.add('hidden');
        });
        
        // Export CSV logic
        downloadBtn.addEventListener('click', () => {
            if (cloudData.length === 0) { alert("Data kosong."); return; }
            let csvContent = "Timestamp,Nama,Barang,Qty,Harga,Total,Keterangan\n";
            cloudData.forEach(item => {
                csvContent += `${item.timestamp},${item.nama},${item.barang},${item.qty},${item.harga},${item.total},${item.keterangan}\n`;
            });
            const link = document.createElement("a");
            link.setAttribute("href", URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })));
            link.setAttribute("download", `penjualan_${new Date().toISOString().slice(0,10)}.csv`);
            link.click();
        });

    </script>
</body>
</html>